---
title: "\\huge Programa Nacional de Redução de Filas \\linebreak\\large Relatório de Adesões Estaduais"   
author: "\\phantom{rb}\\linebreak CGMIND/SAES"
date: "\\rightline{`r Sys.setlocale('LC_ALL' , 'pt_BR.utf8')
stringr::str_to_sentence(format.Date(Sys.time()-15400,'%A-feira,%d de %B de %Y, às %H horas'))`}"
portuguese: "true"  
### Uncomment the following line if a summary should be shown after the title 
# abstract: "Lorem ipsum dolor sit amet, consetetur sadipscing elitr."

### Comment or remove the following two lines if NO references are used
bibliography: [bib/references.bib, bib/packages.bib] # Path to bibliography files 
csl: bib/ibict-abnt.csl                            # Path to reference style file
always_allow_html: true
### Settings for rendering the document:
output: 
  cgmindmodelos::pdf_report:
#    keep_tex:true
    toc: false
    includes:
      in_header: header.tex
    font: "Georgia" # alternative: "Helvetica" 
### Comment the next line if 'language: "en" ' and 'toc: true'
  #toc-title: "Sumário"    
---

\renewcommand{\tablename}{Tabela}

```{r setup, include = FALSE}
# settings --> keep this chunk as it is!
options(scipen=99999)
knitr::opts_chunk$set(echo = FALSE, message = FALSE, 
  warning = FALSE, error = FALSE, cache = TRUE,
  fig.path='figs/', cache.path = 'cache/')
```

```{r load-packages, include = FALSE}
# Load all your packages that you need later
library(knitr)
library(tidyverse)
source("../../requ.R")
```

```{r generate-package-refs, include=FALSE}
# Automatically create a bib database for R packages used above
knitr::write_bib(
  x = c(.packages(), 'bookdown', 'rmarkdown', 
    # Add here now all packages that are loaded above:
    'knitr'), 
  file = 'bib/packages.bib')
```

```{r carrega-dados,include=F}
source("../../R/paletas.R") 
source("../../R/utils.R")
source("../../RR/adesao_monitora.R")
source("../../R/paletas.R")
source("../../RR/estaticospainel.R")
source("../../RR/filas_planilhas.R")
situacoes_propostas <- c(
  "Incompleta","Enviada para o MS","Em análise","Em diligência",
  "Em reanálise","Rejeitada","Aprovada","Paga","Gerada Minuta PRT/Memo",
  "Inativa","A Liberar","A Priorizar","Aprovada com ressalva",
  "Reenviada para o MS","Aprovada para implantação","Paga para implantação",
  "Paga com ressalva","Paga e implantada","Documento complementar",
  "Reenviada para o MS - Documentos Complementares","Em reanálise - Documentos Complementares",
  "Cancelada","Suspensa","Rejeitada por não atendimento da diligência",
  "Em diligência - Documentos Complementares")

pl_elab <- nrow(dplyr::filter(base_propostas,estadual == T,Situação %in% c("Incompleta","A Liberar")))-2
pl_cibs <- nrow(base_propostas|>dplyr::filter(estadual == T,`Anexe Resolução CIB ou Colegiado de Gestão:` != "---"))
pl_saips <- nrow(dplyr::filter(base_propostas,estadual == T,`Plano de atendimento - Importe planilha de cumprimento do artigo 6 da PT.\nDisponível em https://www.gov.br/saude/pt-br/composicao/saes/saips/manuais-gerais-do-sistema-saips` != "---"))
pl_analise <- nrow(dplyr::filter(base_propostas,estadual == T,Situação == "Em análise"))
pl_ajustes <- nrow(dplyr::filter(base_propostas,estadual == T,Situação %in% situacoes_propostas[c(4:5,21,25)]))
pl_diligencia <- nrow(dplyr::filter(base_propostas,estadual == T,Situação == situacoes_propostas[4]))

pl_aprovado <- nrow(dplyr::filter(base_propostas,estadual == T,Situação == "Aprovada"))

pegatp <- function(x) {
  length(unique((filas|>filter(UF == x))$NO_PROCEDIMENTO)) 
}

pegacir <- function(x){
  format(round(sum((filas|>dplyr::filter(UF == x))$`Qtde de cirurgias a serem feitas no prazo pactuado`),0),scientific=F,big.mark=".",decimal.mark=",")
}

top5_f <- \(x) {
   filamostra <- filas|>filter(UF == x)|>
      group_by(paste(paste0(0,fni(`CÓDIGO DO PROCEDIMENTO NO SIGTAP`)), str_to_sentence(NO_PROCEDIMENTO), sep =" - "))|>
      summarize(Fila = sum(round(`QUANTIDADE DE SOLICITAÇÕES NA FILA ATÉ DIA 31/12/22`,0)),
        "Cirurgias a realizar" = sum(round(`Qtde de cirurgias a serem feitas no prazo pactuado`,0)),
        UFs = toString(unique(UF)), .groups = 'drop')|>
      arrange(desc(`Cirurgias a realizar`),desc(Fila))|>
      mutate(Perc = format(fnx(100*`Cirurgias a realizar`/sum(`Cirurgias a realizar`)),decimal.mark=",",digits=1),across(where(is.numeric),fni))
   
   

    names(filamostra) <- c("Procedimento","Fila","Cirurgias a realizar","UFs","%")
    
    filamostra$Procedimento <- gsub(" - NA"," - procedimento fora do rol",filamostra$Procedimento)
    kable(filamostra[1:5,c(1:3,5)],caption = paste("Procedimentos previstos na fila - Top 5 -",estados_siglas[estados_siglas$uf == x,]$nome),
            align = c("|p{5.4cm}","p{1cm}","p{2.5cm}","p{1cm}|")) |>
  kableExtra::kable_styling(bootstrap_options = "striped",
                            latex_options =
                              c("striped","repeat_header"),
                            stripe_color = paleta2023[7],
                            full_width = F) |> 
      kableExtra::row_spec(0, background = paleta2023[3],color="white")  

}

pi_tp <- pegatp("PI")
ma_tp <- pegatp("MA")
ba_tp <- pegatp("BA")
es_tp <- pegatp("ES")
ro_tp <- pegatp("RO")

pi_cir <- pegacir("PI")
ma_cir <- pegacir("MA")
ba_cir <- pegacir("BA")
es_cir <- pegacir("ES")
ro_cir <- pegacir("RO")

top5_pi <- top5_f("PI")
top5_ma <- top5_f("MA")
top5_ba <- top5_f("BA")
top5_ro <- top5_f("RO")
top5_es <-  top5_f("ES")

```

# Resumo da Adesão Inicial ao Programa Nacional de Redução de Filas

Situação dos planos no SAIPS:

-   `r pl_elab` com situação incompleta ou a liberar(prévios ao envio para o MS);

-   `r pl_cibs` aprovados na CIB;

-   `r pl_saips` planos enviados ao SAIPS;

-   `r pl_analise` plano(s) em análise;

-   `r pl_diligencia` plano(s) em diligência ;

-   `r pl_aprovado` planos aprovados;


O total de procedimentos nas filas informadas é de: `r fni(round(sum(filas[,"Qtde de cirurgias a serem feitas no prazo pactuado"],na.rm=T))) `

    # Análise sintética dos planos estaduais enviados ao MS

## Piauí

Foram contempladas as 11 regionais de saúde do PI. Note-se que três não receberam nesse primeiro repasse;

São `r pi_tp` tipos de procedimentos cirúrgicos, totalizando `r pi_cir` cirurgias, a serem realizadas em 25 Estabelecimentos, sendo: 15 de gestão de serviço municipal e 10 estadual, destes todos realizam os 23 procedimentos, com exceção de 1, que realiza 16;

O planejamento é cumprir o plano em 3 meses;

Está pendente o preenchimento do cronograma financeiro.

```{r pifila,echo=F}
top5_pi
```

## Maranhão

O tamanho da fila é de 47.488 cirurgias, o objetivo do plano é reduzir em 59%. São 483 tipos de procedimentos cirúrgicos, totalizando 28.241 cirurgias, no prazo de 10 meses. Os procedimentos cirúrgicos serão realizados em 65 Estabelecimentos, sendo: 41 de gestão de serviço municipal e 24 estadual, destes tem estabelecimentos que só vão realizar 01 tipo de procedimento enquanto tem outro q pode realizar até 184 procedimentos. De acordo com o cronograma financeiro, o Maranhão executará 100% dos recursos repassados nos meses de março à dezembro, tendo seu ápice no mês de maio!

\newpage

Top 5 dos procedimentos cirúrgicos são:

```{r mafila,echo=F}
top5_ma
```

## Bahia

O tamanho da fila é de 82.675 cirurgias, o objetivo planejado é de reduzir em 59%.

São 316 tipos de procedimentos cirúrgicos, totalizando 48.470 cirurgias, no prazo de 03 à 12 meses (dependendo do tipo de procedimento). OBS 1: Tem procedimentos com o prazo de redução proposto para 12 meses, no entanto é necessário verificar uma vez q o cronograma financeiro é para 10 meses. OBS 2: o procedimento 405050364 referente ao tratamento cirúrgico de Pterígio tem uma fila de 10.370 e foi planejado a realização de 5.185 cirurgias, no entanto o mesmo não está no rol de procedimento contemplados pelo Programa, além disso esse procedimento é o segundo mais demandado, como pode-se observar na tabela abaixo. Caso não seja considerado esse procedimento, os números da Bahia sofrerão alterações.

Os procedimentos cirúrgicos poderão ser realizados em 189 Estabelecimentos.

De acordo com o cronograma financeiro, a Bahia executará 100% dos recursos repassados nos meses de março à dezembro.

Top 5 dos procedimentos cirúrgicos são:

```{r bafila,echo=F}
top5_ba |> kableExtra::row_spec(2, background = paleta2023[4],color="white")  
```

## Roraima

São `r ro_tp` tipos de procedimentos cirúrgicos, totalizando `r ro_cir` cirurgias, a serem realizadas. Top 5 dos procedimentos cirúrgicos são:

```{r rofila,echo=F}
 top5_ro
```

## Espírito Santo

São `r length(unique((filas|>filter(UF == "ES"))$NO_PROCEDIMENTO))` tipos de procedimentos cirúrgicos, totalizando `r round(sum(filas|>filter(UF == "ES")|>dplyr::select("Qtde de cirurgias a serem feitas no prazo pactuado"),na.rm=T),0)` cirurgias, a serem realizadas.

Top 5 dos procedimentos cirúrgicos são:

```{r esfila,echo=F}
 top5_es
```

```{r tabela1,echo = F}

names(monextradrac) <- str_to_sentence(names(monextradrac))
monextradrac[,1:6] <- apply(monextradrac[,1:6],2,str_to_sentence)
monextradrac$`Valor do recurso` <- paste("R$",format(monextradrac$`Valor do recurso`,nsmall=2,decimal.mark=",",big.mark=".",scientific=F))
monextradrac$`Nº da proposta` <- paste("Nº",format(as.numeric(monextradrac$`Nº da proposta`),decimal.mark=",",big.mark=".",scientific=F))

monextradrac$Cadastrador <- str_to_title(monextradrac$Cadastrador)

monextradrac$Telefone <- substr(monextradrac$Telefone,1,14)
names(monextradrac)[c(1,10)] <- c("UF","Região")
monextradrac$UF <- str_to_upper(monextradrac$UF)
kable(arrange(monextradrac[,c("Região","UF","Situação","Valor do recurso","Cadastrador","Telefone")],Região,Cadastrador %in% c("n.d.","---")),
      col.names=names(monextradrac[,c("Região","UF","Situação","Valor do recurso","Cadastrador","Telefone")]),
      align = c("|p{1.4cm}","p{1cm}","p{3cm}","p{3cm}","p{3.5cm}","p{2.5cm}|"),
      caption = "Informações sobre a adesão ao Programa Nacional de Redução de Filas") |>
  kableExtra::kable_styling(bootstrap_options = "striped",
                            latex_options =
                              c("striped","repeat_header"),
                            stripe_color = paleta2023[7],
                            full_width = F)
```
